<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Lu Ying's home" href="https://lu1hoao.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Lu Ying's home" href="https://lu1hoao.github.io/atom.xml"><link rel="alternate" type="application/json" title="Lu Ying's home" href="https://lu1hoao.github.io/feed.json"><link rel="stylesheet" href="/js/prism/prism.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="OS,Memory"><link rel="canonical" href="https://lu1hoao.github.io/2022/05/12/os/os-9/"><title>Main Memory (下) - 作業系統小科普 | Lu Ying = Lu Ying's home</title><meta name="generator" content="Hexo 6.1.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Lu Ying</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="https://i.imgur.com/IHeDLgP.jpg"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1%E5%B0%8F%E7%A7%91%E6%99%AE/" itemprop="item" rel="index" title="In 作業系統小科普"><span itemprop="name">作業系統小科普</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://lu1hoao.github.io/2022/05/12/os/os-9/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/%E6%88%91.png"><meta itemprop="name" content="LuYing"><meta itemprop="description" content=", 生活紀錄"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Lu Ying's home"></span><div class="body md" itemprop="articleBody"><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>本篇文主要講述 page table 和更多 paging 細節，並對整個 main maemory 做回顧，強烈建議搭配上篇一同觀看</p><h3 id="Implementation-of-Page-Table"><a href="#Implementation-of-Page-Table" class="headerlink" title="Implementation of Page Table"></a>Implementation of Page Table</h3><p>依照上篇提過的 page 方法，我們發現從 page 轉到 frame 需要一個 page table ，而這個 page table 就存在 memory 裡，然而問題來了，我們把資料放進 memory 得過程竟然要存取兩次 memory (一次到 page pagetable 一次到 frame) 這樣也太沒效率了吧！因此我們把 page table 放在一個類似 cache 的硬體，稱作 translation look-aside buffers (TLBs)，如果我們要找的 page 沒出現在 TLB ，這時候稱為 miss ，我們必須到主記憶體去把他的轉換資料找出來並放到 TLB 內，但有了 TLB 這個硬體可以大幅幫助我們提升效率<br>加了 TLB 的 address transfer 如下圖</p><p><img data-src="https://i.imgur.com/NZVxgy8.png"></p><h3 id="Effevtive-Access-Time"><a href="#Effevtive-Access-Time" class="headerlink" title="Effevtive Access Time"></a>Effevtive Access Time</h3><p>雖然字面上說增加 TLB 可以提高效率，但還是很沒有實感，那我們就來看看一個例子吧：<br>假設 TLB 的存取速度是 20ns ，記憶體的存取速度是 100ns ，有百分之八十的 page 在 TLB 當中就可以取得轉換資訊，那麼平均存取時間就是</p><p><img data-src="https://i.imgur.com/XKke5l4.png"></p><p>意義是有百分之八十的 page 存取一次 TLB 存取一次 memory ，百分之二十的 page ，存取一次 TLB 沒找到，又再去 page table 找 (存取第一次記憶體) 找到 fram number 後又存取第二次記憶體<br>因此若有越高的比率可以在 TLB 就找到資訊，存取速度就會越快</p><h3 id="Memory-Protection"><a href="#Memory-Protection" class="headerlink" title="Memory Protection"></a>Memory Protection</h3><p>Page table 除了給予 page 對應到 frame 的位置資訊，也會有一些 bit 記錄這些 page 的其他資訊，像是 valid-invalid bit，因為同一時刻 page table 內可能會有多個 process 的資訊，要避免存取到不是自己的 page ，又或者紀錄這個 page 是否被更動過。對於某些共用部分 code 的 process 而言，我們把這些 shared code 稱為 reentrant，含有這些 code 的 page 可能就會常駐在 TLB 中，一般而言，每次 context switch ，TLB 和 page table 也要被更新</p><h3 id="Structure-of-page-table"><a href="#Structure-of-page-table" class="headerlink" title="Structure of page table"></a>Structure of page table</h3><p>前面提過 page table 的大小和 page size 有關，假設今天有個 process 的資訊量是 2 的 32 次方，而 page size 是 4KB ( 2 的 12 次方)，所以這個 process 會用掉 1M ( 2的 20 次方 )個 page，換句話說會有 1M 個 page 地址，假設每個地址需要 4 byte 空間，1M 個地址就會佔去 4M ，佔據記憶體 4M 的空間實在太大了，更何況我們不一定會真正利用到 page table 中的每項資訊，因此如何使放在記憶體當中的資訊不要那麼多，就發展出了以下三種作法</p><ol><li>Hierarchical Paging</li><li>Hashed Page Tables</li><li>Inverted Page Tables</li></ol><p>其中，Hierarchical Paging 又被稱為 multi-level paging 或 Two-level paging 或 forward-mapped paging ，是實務上最常見的方法</p><p><strong>Hierarchical Paging</strong>：</p><p>是把 page table 在做分割，假設現在圖書館有 1000 本書，我們分成 100 個書架，每個書架有 10 本書，要找一本書的時候就先看他在哪一個書架再去該書架找 (這是原本的 page )現在又把這 100 個書架分成 10 區，每區有 10 個書架，要找一本書的時候先看他在哪一區，再看他在該區的哪一個書架，最後再到該書架的 10 本書中去找，後者就是 Two-level paging</p><p>原本的 logical address 包含兩個部分，一個是 page number ，一個是 offset ，page number 表示該 page 在 page table 的 index，現在我們把 page number 切成兩個部分，一個表示他對應到哪一個 page table (又稱 outer page )，一個表示他在該 page table 中的 index (又稱 inner page)。</p><p>我們把圖書館的例子用圖片說明，單純的 page 收到以下訊號</p><p><img data-src="https://i.imgur.com/kb8lRiZ.png"></p><p>代表第 83 個書架中的第六本書，而這個圖書館必須在門口張貼一張表，表上有 100 個書架的位置</p><p>two level paging 收到這樣的訊號則會做以下解讀</p><p><img data-src="https://i.imgur.com/sglq3Z8.png"></p><p>代表第 8 區、第 3 個書架、第 6 本書，而這個圖書館必須張貼一張表，表上有 10 個區域的位置，每個區域入口處也要有屬於該區 10 個書架的位置。</p><p>對記憶體而言 (相當於對圖書館而言) 他需要紀錄的東西從 100 個書架的位址縮小成 10 個區域的位置，減少了很大的負擔。對 CPU 而言 (相當於要找書的人而言)，也不需要修改自己表示資訊的方式 (address 長度不變)，只要換個角度看待資訊就好了。在主記憶體當中只需要存放一個 page table (即圖書館門口的區域位置表)，對每一個 page table 而言，專屬於他們的第二層 page table (相當於各區域門口的書架位址)放在 disk 即可，需要的時候再去拿，而拿取的技術可以使用前一篇文章提到的 memory image<br>在 two level paging 中會收到兩個位址資訊，其中第一個位址資訊又會成為第二個位址資訊的查詢基礎，有點指來指去的概念。</p><p><strong>Hashed Page Table</strong>：</p><p>顧名思義就是利用雜湊函數對資料作處理，在主記憶體當中存放雜湊表，假設收到以下資訊</p><p><img data-src="https://i.imgur.com/mPu26jr.png"></p><p>我們先把 83 mod 7 ，發現餘 6 ，於是找到第六項在去做更進一步處理，看是利用 linklist 或是第二個 page table 還是怎樣都可以，但主記憶體當中只需要存取一個有 7 個項目的雜湊表 ( 餘數從 0 到 6 )，在做雜湊表的時候我們都常會假設資訊是 sparse 的，意思是平均分散的，這樣可以避免 link list 過長。</p><h3 id="Intel-32"><a href="#Intel-32" class="headerlink" title="Intel 32"></a>Intel 32</h3><p>在實務上也不是只有利用一種方法做 virtual address 的轉換， Intel 32 就是結合 segmentation 和 paging 的例子，這樣可以結合兩者的優點， segmentation 比較符合人類的分法， 把同樣性質的資料放在一起，paging 則是可以避免 external fragmentation ，所以在 Intel 32 是這樣做的，在 logical address 階段，會得到 segment 資訊和 offset，segmet 資訊稱為 selector，是一個指標，然後在到 descriptor table 中找到他的 base 和 limit ，把 offset 加上 base 之後得到 linear address ，linear assdess 再透過兩次 paging 得到 physical address ，以圖片說明下</p><p><img data-src="https://i.imgur.com/lOacBea.png"></p><p>以上就是記憶體的小小小科普，祝大家閱讀愉快</p><div class="tags"><a href="/tags/OS/" rel="tag"><i class="ic i-tag"></i> OS</a> <a href="/tags/Memory/" rel="tag"><i class="ic i-tag"></i> Memory</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-05-12 21:07:44" itemprop="dateModified" datetime="2022-05-12T21:07:44+08:00">2022-05-12</time></span></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>LuYing <i class="ic i-at"><em>@</em></i>Lu Ying's home</li><li class="link"><strong>Post link: </strong><a href="https://lu1hoao.github.io/2022/05/12/os/os-9/" title="Main Memory (下)">https://lu1hoao.github.io/2022/05/12/os/os-9/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/05/11/os/os-8/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;i.imgur.com&#x2F;IHeDLgP.jpg" title="Main Memory (上)"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> 作業系統小科普</span><h3>Main Memory (上)</h3></a></div><div class="item right"><a href="/2022/05/14/%E4%B8%80%E9%BB%9E%E9%BB%9E%E6%BC%94%E7%AE%97%E6%B3%95/combination/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;i.imgur.com&#x2F;WFpTQrN.png" title="C 語言組合 (combination)"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> 一點點演算法</span><h3>C 語言組合 (combination)</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%A6%81"><span class="toc-number">1.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Implementation-of-Page-Table"><span class="toc-number">2.</span> <span class="toc-text">Implementation of Page Table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Effevtive-Access-Time"><span class="toc-number">3.</span> <span class="toc-text">Effevtive Access Time</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Protection"><span class="toc-number">4.</span> <span class="toc-text">Memory Protection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Structure-of-page-table"><span class="toc-number">5.</span> <span class="toc-text">Structure of page table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Intel-32"><span class="toc-number">6.</span> <span class="toc-text">Intel 32</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/04/23/os/os-1/" rel="bookmark" title="CPU Scheduling (上)">CPU Scheduling (上)</a></li><li><a href="/2022/04/25/os/os-2/" rel="bookmark" title="CPU Scheduling (下)">CPU Scheduling (下)</a></li><li><a href="/2022/04/27/os/os-3/" rel="bookmark" title="Synchronization Tools (上)">Synchronization Tools (上)</a></li><li><a href="/2022/04/28/os/os-4/" rel="bookmark" title="Synchronization Tools (下)">Synchronization Tools (下)</a></li><li><a href="/2022/04/29/os/os-5/" rel="bookmark" title="Synchronization Examples">Synchronization Examples</a></li><li><a href="/2022/05/02/os/os-6/" rel="bookmark" title="Deadlocks(上)">Deadlocks(上)</a></li><li><a href="/2022/05/02/os/os-7/" rel="bookmark" title="Deadlocks(下)">Deadlocks(下)</a></li><li><a href="/2022/05/11/os/os-8/" rel="bookmark" title="Main Memory (上)">Main Memory (上)</a></li><li class="active"><a href="/2022/05/12/os/os-9/" rel="bookmark" title="Main Memory (下)">Main Memory (下)</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="LuYing" data-src="/images/%E6%88%91.png"><p class="name" itemprop="name">LuYing</p><div class="description" itemprop="description">生活紀錄</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">15</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">3</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">14</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1MWhPQU8=" title="https:&#x2F;&#x2F;github.com&#x2F;lu1hOAO"><i class="ic i-github"></i></span> <a href="/ring910224@gmail.com" title="ring910224@gmail.com" class="item email"><i class="ic i-envelope"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/05/11/os/os-8/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/05/14/%E4%B8%80%E9%BB%9E%E9%BB%9E%E6%BC%94%E7%AE%97%E6%B3%95/combination/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">LuYing @ Lu Ying</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">38k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">35 mins.</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/05/12/os/os-9/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="/js/prism/prism.js" async></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>