<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Lu Ying" href="https://lu1hoao.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Lu Ying" href="https://lu1hoao.github.io/atom.xml"><link rel="alternate" type="application/json" title="Lu Ying" href="https://lu1hoao.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="OS"><link rel="canonical" href="https://lu1hoao.github.io/2022/06/11/os/os-17/"><meta name="description" content="# 概要 本篇文章主要在對檔案系統內部有更詳盡的說明，著重在 file sharing、virtual file systems、remote file systems、consistency semantics 和 NFS。 # Virtual file system(VFS) VFS 是 Unix 提供的介面，允許使用同樣的 systemcall 針對不同的裝置進行檔案讀寫，他是使用 vnod"><meta property="og:type" content="article"><meta property="og:title" content="File System Internals"><meta property="og:url" content="https://lu1hoao.github.io/2022/06/11/os/os-17/index.html"><meta property="og:site_name" content="Lu Ying"><meta property="og:description" content="# 概要 本篇文章主要在對檔案系統內部有更詳盡的說明，著重在 file sharing、virtual file systems、remote file systems、consistency semantics 和 NFS。 # Virtual file system(VFS) VFS 是 Unix 提供的介面，允許使用同樣的 systemcall 針對不同的裝置進行檔案讀寫，他是使用 vnod"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://i.imgur.com/bWF7Ff4.png"><meta property="og:image" content="https://i.imgur.com/5KsVENZ.png"><meta property="og:image" content="https://i.imgur.com/bAbc8Mv.png"><meta property="article:published_time" content="2022-06-11T14:23:28.000Z"><meta property="article:modified_time" content="2022-06-11T04:12:38.213Z"><meta property="article:author" content="Lu Ying"><meta property="article:tag" content="OS"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.imgur.com/bWF7Ff4.png"><title>File System Internals - 作業系統小科普 | Lu Ying = Lu Ying</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">File System Internals</h1><div class="meta"><span class="item" title="Created: 2022-06-11 22:23:28"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-06-11T22:23:28+08:00">2022-06-11</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>2k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>2 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Lu Ying</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="https://i.imgur.com/o6F5bZd.jpg"></div></header><div id="waves"></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1%E5%B0%8F%E7%A7%91%E6%99%AE/" itemprop="item" rel="index" title="In 作業系統小科普"><span itemprop="name">作業系統小科普</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://lu1hoao.github.io/2022/06/11/os/os-17/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/%E6%88%91.png"><meta itemprop="name" content="Lu Ying"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Lu Ying"></span><div class="body md" itemprop="articleBody"><h3 id="概要"><a class="anchor" href="#概要">#</a> 概要</h3><p>本篇文章主要在對檔案系統內部有更詳盡的說明，著重在 file sharing、virtual file systems、remote file systems、consistency semantics 和 NFS。</p><h3 id="virtual-file-systemvfs"><a class="anchor" href="#virtual-file-systemvfs">#</a> Virtual file system(VFS)</h3><p>VFS 是 Unix 提供的介面，允許使用同樣的 systemcall 針對不同的裝置進行檔案讀寫，他是使用 vnode 來記錄 inode 或 network file details，可以把 vnode 想成在 VFS 中的 inode，他存在於 kernel memory ，file sysytem 不能管理自己的 vnode ，必須使用 OS 提供的 function，實務上也會有 Virtual File System library 儲存 vnode。我們可以這樣理解 VFS：他是一個 file system 抽象層，把真正的 file sysytem 變得一致化。就像一個旅行社，你可以透過旅行社買機票、訂飯店，儘管每間航空公司訂機票的程序可能有所不同，但顧客透過旅行社看到的僅有買機票這個選項而不需去考慮背後複雜的處理流程。我們用下圖理解 VFS 扮演的角色</p><p><img data-src="https://i.imgur.com/bWF7Ff4.png" alt=""></p><p>在 Linux 中有 VFS 內包含四種型態：inode,file,super block,dentry，VFS 會規範對這些 object 的操作，每個物件都有一個指標指到 funtion table ，funtion table 會有 addresses routine 去實現這些操作</p><h3 id="remote-file-system"><a class="anchor" href="#remote-file-system">#</a> Remote File system</h3><p>檔案可以藉由網路分享，常見的做法包含兩種：<strong>file transfer</strong> (used by ftp and the WWW)、<strong>distributed file systems (DFS)</strong>，在 client-Sever Model 中，DFS 允許 client mount sever 的 directories 或 file systems 到自己的裝置中，為了確保這個過程是安全的通成會使用 authenticated (給定密碼) 或是授權 unauthorized 的方式。還有一種系統稱為 Distributed information system ，是在記憶使用者的安全憑證，他會把帳號和密碼連接起來，這樣就不用一直重複驗證。<br>在使用 Network file system 時，如果網路掛掉怎麼辦呢？在 Windows 的 NFS 2/3 都是沒有記錄狀態的 (stateless)，如果網路掛掉所做的指令會消失直到網路恢復再重頭來過，NFS 4 則會記錄狀態 (stateful) state information 包含追蹤哪些 file 被 open、哪些東西被哪個 client mount</p><h3 id="file-sharing"><a class="anchor" href="#file-sharing">#</a> File sharing</h3><p>檔案共享的優點很多，可以讓多個使用者存取，但也會遇到很多問題。第一步就是 OS 要去確認這個檔案是不是可以被修改，有些檔案是唯讀檔案，那麼就不能修改內容，檔案的權限會記錄在 file attributes 中。一般而言共享模式有三種，另外我們會使用 Consistency semantic ，來描述檔案共享，翻成中文叫做一致性語意實在不知道在說啥，可以想成是不同系統有不同表示方式，但檔案共享就要有一樣的規範。以下圖理解檔案的三種共享</p><p><img data-src="https://i.imgur.com/5KsVENZ.png" alt=""></p><p>Unix 提供的是互斥存取，所有單位讀取的檔案內容必須是一致的，某個 process 對檔案的任何動作其他檔案都會看到，實務上是會有一個 file pointer 指到目前位置，若有某個 byte 被加上，則 pointer 往下移一個 byte，Session Semantics 則是不具備互斥存取，大家在各自的副本進行讀寫，全部單位看到的內容不一定一致，最後一種則是唯讀檔案，若有多個 access 發生在同一個 file 我們稱為 file session 在檔案 share 當中我們並不是採取之前說過的同步方法，因為這樣會讓效率低落造成很大的 latency，畢竟 disk 和 memory 的存取速度差很多。</p><h3 id="sun-nfs"><a class="anchor" href="#sun-nfs">#</a> SUN NFS</h3><p>NFS 是被設計用來管理不同環境、不同裝置、不同網路架構的檔案，架構必須符合很多 protocol ，我們用下圖理解 NFS 扮演的角色</p><p><img data-src="https://i.imgur.com/bAbc8Mv.png" alt=""></p><p>接下來我們看一個實例，有關 NFS 的操作流程：</p><ol><li>客戶透過 RPC 送出請求到 mount sever</li><li>mount sever 檢查</li></ol><ul><li>file system that can be exported</li><li>legal requesting clients</li><li>it is legitimate to mount any directory within the legal file system</li><li></li></ul><ol start="3"><li>sever returns &quot;file handle&quot; to client</li><li>sener maintains list of clients and mounted directories--this is state information！but this data is omly a &quot;hint&quot; not essential</li><li>mounting often occurs automatically</li></ol><p>單一的 NFS write 或許是 atomic 但整體不是。</p><p>以上就是 OS 小科普最終章！</p><div class="tags"><a href="/tags/OS/" rel="tag"><i class="ic i-tag"></i> OS</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-06-11 12:12:38" itemprop="dateModified" datetime="2022-06-11T12:12:38+08:00">2022-06-11</time></span></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Lu Ying <i class="ic i-at"><em>@</em></i>Lu Ying</li><li class="link"><strong>Post link: </strong><a href="https://lu1hoao.github.io/2022/06/11/os/os-17/" title="File System Internals">https://lu1hoao.github.io/2022/06/11/os/os-17/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/06/10/os/os-16/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;i.imgur.com&#x2F;o6F5bZd.jpg" title="File System Implementation"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> 作業系統小科普</span><h3>File System Implementation</h3></a></div><div class="item right"><a href="/2022/06/20/%E4%B8%80%E9%BB%9E%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B/stack-2/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;i.imgur.com&#x2F;C6qPLDp.jpg" title="堆疊與佇列 (stack&amp;queue) (下)"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> 一點資料結構</span><h3>堆疊與佇列 (stack&queue) (下)</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%A6%81"><span class="toc-number">1.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virtual-file-systemvfs"><span class="toc-number">2.</span> <span class="toc-text">Virtual file system(VFS)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#remote-file-system"><span class="toc-number">3.</span> <span class="toc-text">Remote File system</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file-sharing"><span class="toc-number">4.</span> <span class="toc-text">File sharing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sun-nfs"><span class="toc-number">5.</span> <span class="toc-text">SUN NFS</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/04/23/os/os-1/" rel="bookmark" title="CPU Scheduling (上)">CPU Scheduling (上)</a></li><li><a href="/2022/04/25/os/os-2/" rel="bookmark" title="CPU Scheduling (下)">CPU Scheduling (下)</a></li><li><a href="/2022/04/27/os/os-3/" rel="bookmark" title="Synchronization Tools (上)">Synchronization Tools (上)</a></li><li><a href="/2022/04/28/os/os-4/" rel="bookmark" title="Synchronization Tools (下)">Synchronization Tools (下)</a></li><li><a href="/2022/04/29/os/os-5/" rel="bookmark" title="Synchronization Examples">Synchronization Examples</a></li><li><a href="/2022/05/02/os/os-6/" rel="bookmark" title="Deadlocks(上)">Deadlocks(上)</a></li><li><a href="/2022/05/02/os/os-7/" rel="bookmark" title="Deadlocks(下)">Deadlocks(下)</a></li><li><a href="/2022/05/11/os/os-8/" rel="bookmark" title="Main Memory (上)">Main Memory (上)</a></li><li><a href="/2022/05/12/os/os-9/" rel="bookmark" title="Main Memory (下)">Main Memory (下)</a></li><li><a href="/2022/05/27/os/os-10/" rel="bookmark" title="Virtual Memory (上)">Virtual Memory (上)</a></li><li><a href="/2022/05/29/os/os-11/" rel="bookmark" title="Virtual Memory (中)">Virtual Memory (中)</a></li><li><a href="/2022/05/29/os/os-12/" rel="bookmark" title="Virtual Memory (下)">Virtual Memory (下)</a></li><li><a href="/2022/06/06/os/os-13/" rel="bookmark" title="Mass Storage System">Mass Storage System</a></li><li><a href="/2022/06/07/os/os-14/" rel="bookmark" title="I/O System">I/O System</a></li><li><a href="/2022/06/09/os/os-15/" rel="bookmark" title="File System">File System</a></li><li><a href="/2022/06/10/os/os-16/" rel="bookmark" title="File System Implementation">File System Implementation</a></li><li class="active"><a href="/2022/06/11/os/os-17/" rel="bookmark" title="File System Internals">File System Internals</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Lu Ying" data-src="/images/%E6%88%91.png"><p class="name" itemprop="name">Lu Ying</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">27</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">4</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">15</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1MWhPQU8=" title="https:&#x2F;&#x2F;github.com&#x2F;lu1hOAO"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/06/10/os/os-16/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/06/20/%E4%B8%80%E9%BB%9E%E8%B3%87%E6%96%99%E7%B5%90%E6%A7%8B/stack-2/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Lu Ying @ Lu Ying</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">73k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">1:06</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/06/11/os/os-17/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,copy_tex:!0,katex:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>