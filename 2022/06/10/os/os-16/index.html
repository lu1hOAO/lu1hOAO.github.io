<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Lu Ying" href="https://lu1hoao.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="Lu Ying" href="https://lu1hoao.github.io/atom.xml"><link rel="alternate" type="application/json" title="Lu Ying" href="https://lu1hoao.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="OS"><link rel="canonical" href="https://lu1hoao.github.io/2022/06/10/os/os-16/"><meta name="description" content="# 概要 本篇文章主要講述 File system 的實作、管理 disk (file 儲存之處) 的方法，並說明一些實例。 # File Structure File 是一個虛擬的儲存單位，裡面存放很多使用者覺得相關的內容，而 File system 儲存在 secondary storage，也就是 disk，這個系統應該要支援讀寫、隨機存取等等，而每一個 file 都會有一個 file co"><meta property="og:type" content="article"><meta property="og:title" content="File System Implementation"><meta property="og:url" content="https://lu1hoao.github.io/2022/06/10/os/os-16/index.html"><meta property="og:site_name" content="Lu Ying"><meta property="og:description" content="# 概要 本篇文章主要講述 File system 的實作、管理 disk (file 儲存之處) 的方法，並說明一些實例。 # File Structure File 是一個虛擬的儲存單位，裡面存放很多使用者覺得相關的內容，而 File system 儲存在 secondary storage，也就是 disk，這個系統應該要支援讀寫、隨機存取等等，而每一個 file 都會有一個 file co"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://i.imgur.com/vcn5YH0.png"><meta property="og:image" content="https://i.imgur.com/vtB7Wom.png"><meta property="og:image" content="https://i.imgur.com/eCl3D6E.png"><meta property="og:image" content="https://i.imgur.com/hF3LKl6.png"><meta property="og:image" content="https://i.imgur.com/WarMzSU.png"><meta property="og:image" content="https://i.imgur.com/VXFOWz7.png"><meta property="article:published_time" content="2022-06-10T14:23:28.000Z"><meta property="article:modified_time" content="2022-06-10T10:48:46.313Z"><meta property="article:author" content="Lu Ying"><meta property="article:tag" content="OS"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.imgur.com/vcn5YH0.png"><title>File System Implementation - 作業系統小科普 | Lu Ying = Lu Ying</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">File System Implementation</h1><div class="meta"><span class="item" title="Created: 2022-06-10 22:23:28"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2022-06-10T22:23:28+08:00">2022-06-10</time> </span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">Symbols count in article</span> <span>2.9k</span> <span class="text">words</span> </span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">Reading time</span> <span>3 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Lu Ying</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="https://i.imgur.com/o6F5bZd.jpg"></div></header><div id="waves"></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1%E5%B0%8F%E7%A7%91%E6%99%AE/" itemprop="item" rel="index" title="In 作業系統小科普"><span itemprop="name">作業系統小科普</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://lu1hoao.github.io/2022/06/10/os/os-16/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/%E6%88%91.png"><meta itemprop="name" content="Lu Ying"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Lu Ying"></span><div class="body md" itemprop="articleBody"><h3 id="概要"><a class="anchor" href="#概要">#</a> 概要</h3><p>本篇文章主要講述 File system 的實作、管理 disk (file 儲存之處) 的方法，並說明一些實例。</p><h3 id="file-structure"><a class="anchor" href="#file-structure">#</a> File Structure</h3><p>File 是一個虛擬的儲存單位，裡面存放很多使用者覺得相關的內容，而 File system 儲存在 secondary storage，也就是 disk，這個系統應該要支援讀寫、隨機存取等等，而每一個 file 都會有一個 file control block (FCB)，如同之前提過的 process block ，紀錄關於 file 的資料 (大部分是 index)，在 Unix 的 file conrtrol block 又稱為 inode。對應用程式而言，開啟 file name 的方式無非就是呼喊 file name，之後的事情就是 OS 處理，但是在不同儲存裝置中其實需要不同的 file system ，因此我們可以用 layer 來看待電腦處理 file 這件事。</p><p><img data-src="https://i.imgur.com/vcn5YH0.png" alt=""></p><p>其中 logical file system 又稱為 virtual file system (VFS)<br>我們由上而下開始說明，<strong>logical file system</strong> 管理中間的資訊，我們稱為 <strong>metadata</strong>，會把 file name 轉成 file number，而他是參考 file control block 的資訊做轉換。<strong>file organization module</strong> 理解 file 的運作，會把 logical block 轉成 physical block ，同時管理 free space ，<strong>Basic file system</strong> 則會給與 command 像是 retrive block 123 這樣的指令給 <strong>device driver</strong>。device drivers 是負責控制 I/O ，他會給 <strong>device contoller</strong> 明確指令，告訴她把哪個 sector 的資料，放到 memory 的哪裡。<br>Layer 的概念可以降低複雜度，但可能會造成 overhead。</p><h3 id="file-system-implementation"><a class="anchor" href="#file-system-implementation">#</a> File System Implementation</h3><p>首先在 disk 中會有 boot control block ，這裡面包含 OS 的資料以方便我們開機時使用，通常是在第一個 block，接下來會有所謂的 volume control block (或稱 superblock、mastr file table) 記錄這些 file 的 detail ，像是 block 的總數、free block 的總數、free block 的位置等等。我們用下圖理解開啟一個檔案 (open) 與讀一個檔案 (read) 的流程</p><p><img data-src="https://i.imgur.com/vtB7Wom.png" alt=""></p><p>系統會先到目錄 (此刻已在 memory 中) 尋找所需檔案的位置，然後到目錄所記錄的區域尋找該 file 的 control block 。<br>接下來看 read 一個 file 的流程</p><p><img data-src="https://i.imgur.com/eCl3D6E.png" alt=""></p><p>當我們找到一個 file 的位置之後，我們就可以讀他，並且把它放到 process open file table 以防日後需要用到，也放到 system open file table 中，讓其他 process 也可以用。<br>而在 directory 的實現中，通常有 linear list 的方式和 hash table 的方式。</p><h3 id="file-allocation-methods"><a class="anchor" href="#file-allocation-methods">#</a> File Allocation Methods</h3><p>就像記憶體管理一樣 file allocation 也是一件重要的事，以下簡介 Contiguous allocation 、Linked allocation、Indexed allocation 三種方法</p><ul><li><strong>Contiguous allocation</strong><br>每個 file 佔據的 block 都是連續的，所以只要知道起始 block 和 block 的總數目我們就可以輕易存取，他的存取速度也是最快的，因為指針不需要一直跑來跑去，但是會面臨 external fragmentation 的問題，若是要進行 compation 也會很花時間，稱為 compation off line，我們可以用下圖理解 contiguous allocation<br>其中黃色區塊表示 count 這個 file　的範圍，綠色區塊表示 tr 這個 file。<br>很多比較新的檔案系統則會使用 Extend-Based System ，這是考慮檔案會不斷增長所做的修改版。檔案的增加部分也會儲存在連續的 block 當中，為甚麼這麼固執呢？因為連續存取的速度很快呀！</li></ul><p><img data-src="https://i.imgur.com/hF3LKl6.png" alt=""></p><ul><li><strong>Linked allocation</strong><br>顧名思義就是使用 linked list 來記錄 block 的位置，雖然不需拘泥在連續 block　上，意味著空間的使用更有彈性，但也代表我們很不方便直接存取，每次想找一個　block 都得從頭開始，所以實作上有時也會使用 clustering blocks 的方式，把多個 block 視為一個分配單位，用以縮短 linked list 的長度，但也增加 internal fragmentation，另外，這樣做也缺乏可靠性，因為 linked 一旦斷了就無法存取了。我們可以用下圖理解。linked list 的改良版是使用 FAT (File Allocation Table) 紀錄已造訪的 block 路徑，這樣下次就比較快</li></ul><p><img data-src="https://i.imgur.com/WarMzSU.png" alt=""></p><ul><li><strong>Indexed Allocation</strong><br>每一個 file 都會有專屬的 index block 用來記錄該 file 的 data blocks，所以在目錄中我們只需紀錄 index block 的 index，而這也是使用隨機存取的方式，我們可以用下圖理解</li></ul><p><img data-src="https://i.imgur.com/VXFOWz7.png" alt=""></p><p>總結來說 contigious 對於 sequential 和 random acess 的存取速度都很好，linked 適合 sequential ，indexed 比較複雜但是和隨機存取，而 cludter 則可以幫助 CPU 免於 overhead</p><h3 id="free-list-of-blocks"><a class="anchor" href="#free-list-of-blocks">#</a> Free list of blocks</h3><p>我們需要 data block 的 free list，也需要 inode 的 free list，有些會使用 bit vextor (bit map) ，他是一個有 n 個空間的 string，表示 n 個 block 的使用情況，0 表示被占用，而 1 表示空的，CPU 也有指令可以回傳第一個 1 (空的) block 編號，也可以用 link list 把所有 free 的 block 都存起來辦這樣比較不方便存取連續空的 block。</p><h3 id="efficiency-and-performance"><a class="anchor" href="#efficiency-and-performance">#</a> Efficiency and Performance</h3><p>為了提升 disk 的效率，最常見的做法就是使用 buffer cache，這裡的 cache 指的是 a copy of data (不是硬體的那種)，他是記憶體的一部分，紀錄比較常用的 block，另外也有 free behind 和 read ahead 的方式來最佳化 sequeential access，另外有些還會使用 page cache 讓 memory-mapped I/O 使用用以提高效率，如果 buffer cache 也支援 page cache 我們就稱為 unified buffer cache，這樣可以避免 一個 block 同時在 page cache 和 buffer cache 的狀況 (又稱 double caching)，但這樣就要決定如果 I/O 和 memory-mapped I/O 都要使用誰的優先權較高。</p><h3 id="backup-and-recovery"><a class="anchor" href="#backup-and-recovery">#</a> Backup and Recovery</h3><p>在檔案系統中，有 log structured file system (LFS) 幫助我們紀錄檔案的每次修改，這個過程就像交易一樣，在檔案修改之前要先寫一個紀錄到 log structure 中，之後若檔案想復原我們就有之前的資料，或者我們也可以用 Snapshots 紀錄檔案某個時刻的狀態，方便我們復原</p><p>以上就是檔案系統的實作 祝大家閱讀愉快！</p><div class="tags"><a href="/tags/OS/" rel="tag"><i class="ic i-tag"></i> OS</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2022-06-10 18:48:46" itemprop="dateModified" datetime="2022-06-10T18:48:46+08:00">2022-06-10</time></span></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Lu Ying <i class="ic i-at"><em>@</em></i>Lu Ying</li><li class="link"><strong>Post link: </strong><a href="https://lu1hoao.github.io/2022/06/10/os/os-16/" title="File System Implementation">https://lu1hoao.github.io/2022/06/10/os/os-16/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/06/09/os/os-15/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;i.imgur.com&#x2F;o6F5bZd.jpg" title="File System"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i> 作業系統小科普</span><h3>File System</h3></a></div><div class="item right"><a href="/2022/06/11/os/os-17/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;i.imgur.com&#x2F;o6F5bZd.jpg" title="File System Internals"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i> 作業系統小科普</span><h3>File System Internals</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%A6%81"><span class="toc-number">1.</span> <span class="toc-text">概要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file-structure"><span class="toc-number">2.</span> <span class="toc-text">File Structure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file-system-implementation"><span class="toc-number">3.</span> <span class="toc-text">File System Implementation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file-allocation-methods"><span class="toc-number">4.</span> <span class="toc-text">File Allocation Methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#free-list-of-blocks"><span class="toc-number">5.</span> <span class="toc-text">Free list of blocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#efficiency-and-performance"><span class="toc-number">6.</span> <span class="toc-text">Efficiency and Performance</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#backup-and-recovery"><span class="toc-number">7.</span> <span class="toc-text">Backup and Recovery</span></a></li></ol></div><div class="related panel pjax" data-title="Related"><ul><li><a href="/2022/04/23/os/os-1/" rel="bookmark" title="CPU Scheduling (上)">CPU Scheduling (上)</a></li><li><a href="/2022/04/25/os/os-2/" rel="bookmark" title="CPU Scheduling (下)">CPU Scheduling (下)</a></li><li><a href="/2022/04/27/os/os-3/" rel="bookmark" title="Synchronization Tools (上)">Synchronization Tools (上)</a></li><li><a href="/2022/04/28/os/os-4/" rel="bookmark" title="Synchronization Tools (下)">Synchronization Tools (下)</a></li><li><a href="/2022/04/29/os/os-5/" rel="bookmark" title="Synchronization Examples">Synchronization Examples</a></li><li><a href="/2022/05/02/os/os-6/" rel="bookmark" title="Deadlocks(上)">Deadlocks(上)</a></li><li><a href="/2022/05/02/os/os-7/" rel="bookmark" title="Deadlocks(下)">Deadlocks(下)</a></li><li><a href="/2022/05/11/os/os-8/" rel="bookmark" title="Main Memory (上)">Main Memory (上)</a></li><li><a href="/2022/05/12/os/os-9/" rel="bookmark" title="Main Memory (下)">Main Memory (下)</a></li><li><a href="/2022/05/27/os/os-10/" rel="bookmark" title="Virtual Memory (上)">Virtual Memory (上)</a></li><li><a href="/2022/05/29/os/os-11/" rel="bookmark" title="Virtual Memory (中)">Virtual Memory (中)</a></li><li><a href="/2022/05/29/os/os-12/" rel="bookmark" title="Virtual Memory (下)">Virtual Memory (下)</a></li><li><a href="/2022/06/06/os/os-13/" rel="bookmark" title="Mass Storage System">Mass Storage System</a></li><li><a href="/2022/06/07/os/os-14/" rel="bookmark" title="I/O System">I/O System</a></li><li><a href="/2022/06/09/os/os-15/" rel="bookmark" title="File System">File System</a></li><li class="active"><a href="/2022/06/10/os/os-16/" rel="bookmark" title="File System Implementation">File System Implementation</a></li><li><a href="/2022/06/11/os/os-17/" rel="bookmark" title="File System Internals">File System Internals</a></li></ul></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Lu Ying" data-src="/images/%E6%88%91.png"><p class="name" itemprop="name">Lu Ying</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">26</span> <span class="name">posts</span></a></div><div class="item categories"><a href="/categories/"><span class="count">4</span> <span class="name">categories</span></a></div><div class="item tags"><a href="/tags/"><span class="count">15</span> <span class="name">tags</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1MWhPQU8=" title="https:&#x2F;&#x2F;github.com&#x2F;lu1hOAO"><i class="ic i-github"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>About</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/06/09/os/os-15/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/06/11/os/os-17/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Lu Ying @ Lu Ying</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="Symbols count total">69k words</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="Reading time total">1:03</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/06/10/os/os-16/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,copy_tex:!0,katex:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>